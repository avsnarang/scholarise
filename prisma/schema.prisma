generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Branch {
  id                   String                 @id @default(cuid())
  name                 String
  code                 String                 @unique
  address              String?
  city                 String?
  state                String?
  country              String?
  phone                String?
  email                String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  order                Int                    @default(0)
  admissionLeads       AdmissionLead[]
  chapters             Chapter[]
  classes              Class[]
  classwiseFees        ClasswiseFee[]
  departments          Department[]
  designations         Designation[]
  employees            Employee[]
  employeeBranchAccess EmployeeBranchAccess[]
  feeCollections       FeeCollection[]
  feeHeads             FeeHead[]
  feeTerms             FeeTerm[]
  leavePolicies        LeavePolicy[]
  moneyCollections     MoneyCollection[]
  students             Student[]
  teachers             Teacher[]
  routes               TransportRoute[]
  attendanceDevices    AttendanceDevice[]
  attendanceLocations  AttendanceLocation[]
  attendanceWindows    AttendanceWindow[]
  locationTypes        LocationType[]
  backgroundTasks      BackgroundTask[]
  emailConfiguration   EmailConfiguration?
  // Examination relations
  examTypes            ExamType[]
  examConfigurations   ExamConfiguration[]
  examSchedules        ExamSchedule[]
  seatingPlans         SeatingPlan[]
  marksEntries         MarksEntry[]
  assessmentCategories AssessmentCategory[]
  assessmentConfigs    AssessmentConfiguration[]
  assessmentMarks      AssessmentMarks[]
  gradeScales          GradeScale[]
  // Customizable Assessment Engine relations
  assessmentSchemas    AssessmentSchema[]
  studentAssessmentScores StudentAssessmentScore[]
  assessmentPermissions AssessmentPermission[]
}

model Student {
  id                     String                @id @default(cuid())
  admissionNumber        String                @unique
  firstName              String
  lastName               String
  dateOfBirth            DateTime
  gender                 String
  address                String?
  phone                  String?
  email                  String?
  personalEmail          String?
  bloodGroup             String?
  religion               String?
  nationality            String?
  caste                  String?
  aadharNumber           String?
  udiseId                String?
  joinDate               DateTime              @default(now())
  dateOfAdmission        DateTime?
  rollNumber             Int?                  @db.SmallInt
  isActive               Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  branchId               String
  parentId               String?
  username               String?
  password               String?
  permanentAddress       String?
  permanentCity          String?
  permanentState         String?
  permanentCountry       String?
  permanentZipCode       String?
  correspondenceAddress  String?
  correspondenceCity     String?
  correspondenceState    String?
  correspondenceCountry  String?
  correspondenceZipCode  String?
  previousSchool         String?
  lastClassAttended      String?
  mediumOfInstruction    String?
  recognisedByStateBoard Boolean?
  schoolCity             String?
  schoolState            String?
  reasonForLeaving       String?
  clerkId                String?
  cbse10RollNumber       String?
  cbse12RollNumber       String?
  sectionId              String?
  academicRecords        AcademicRecord[]
  feeCollections         FeeCollection[]
  moneyCollectionItems   MoneyCollectionItem[]
  branch                 Branch                @relation(fields: [branchId], references: [id])
  parent                 Parent?               @relation(fields: [parentId], references: [id])
  section                Section?              @relation(fields: [sectionId], references: [id])
  studentAttendance      StudentAttendance[]
  studentSiblings        StudentSibling[]      @relation("StudentToSibling")
  siblingRelationships   StudentSibling[]      @relation("SiblingToStudent")
  subjects               StudentSubject[]      // Student-Subject enrollments
  transferCertificates   TransferCertificate[] // Transfer certificates for the student
  transportAssignments   TransportAssignment[] // Transport assignments (bus routes)
  // Examination relations
  seatingPlans           SeatingPlan[]
  marksEntries           MarksEntry[]
  assessmentMarks        AssessmentMarks[]
  // Customizable Assessment Engine relations
  studentAssessmentScores StudentAssessmentScore[]
  
  // Add database indexes for performance
  @@index([branchId, admissionNumber], name: "student_branch_admission_idx")
  @@index([branchId, isActive], name: "student_branch_active_idx")
  @@index([sectionId, isActive], name: "student_section_active_idx")
  @@index([admissionNumber, branchId], name: "student_admission_branch_idx")
}

model Parent {
  id                 String    @id @default(cuid())
  fatherName         String?
  fatherDob          DateTime?
  fatherEducation    String?
  fatherOccupation   String?
  fatherMobile       String?
  fatherEmail        String?
  fatherAadharNumber String?
  motherName         String?
  motherDob          DateTime?
  motherEducation    String?
  motherOccupation   String?
  motherMobile       String?
  motherEmail        String?
  motherAadharNumber String?
  guardianName       String?
  guardianDob        DateTime?
  guardianEducation  String?
  guardianOccupation String?
  guardianMobile     String?
  guardianEmail      String?
  guardianAadharNumber String?
  parentAnniversary  DateTime?
  monthlyIncome      String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  clerkId            String?
  students           Student[]
}

model Teacher {
  id                         String             @id @default(cuid())
  firstName                  String
  lastName                   String
  qualification              String?
  specialization             String?
  joinDate                   DateTime           @default(now())
  isActive                   Boolean            @default(true)
  createdAt                  DateTime           @default(now())
  updatedAt                  DateTime           @updatedAt
  userId                     String?            @unique
  branchId                   String
  employeeCode               String?            @unique
  clerkId                    String?
  certifications             String[]           @default([])
  subjects                   String[]           @default([])
  aadharNumber               String?
  accessCardId               String?
  accountNumber              String?
  address                    String?
  alternatePhone             String?
  assetReturnStatus          String?
  bankName                   String?
  bio                        String?
  bloodGroup                 String?
  city                       String?
  confirmationDate           DateTime?
  country                    String?
  dateOfBirth                DateTime?
  department                 String?
  designation                String?
  deviceIssued               String?
  emergencyContactName       String?
  emergencyContactPhone      String?
  emergencyContactRelation   String?
  employeeType               String?
  esiNumber                  String?
  experience                 String?
  gender                     String?
  ifscCode                   String?
  institution                String?
  maritalStatus              String?
  middleName                 String?
  nationality                String?
  officialEmail              String?
  panNumber                  String?
  permanentAddress           String?
  permanentCity              String?
  permanentCountry           String?
  permanentPincode           String?
  permanentState             String?
  personalEmail              String?
  pfNumber                   String?
  phone                      String?
  pincode                    String?
  previousEmployer           String?
  previousExperience         String?
  professionalQualifications String?
  religion                   String?
  reportingManager           String?
  salaryStructure            String?
  softwareLicenses           String?
  specialCertifications      String?
  state                      String?
  uanNumber                  String?
  yearOfCompletion           String?
  leaveApplications          LeaveApplication[]
  leaveBalances              LeaveBalance[]
  salaryIncrements           SalaryIncrement[]
  branch                     Branch             @relation(fields: [branchId], references: [id])
  sections                   Section[]          // Teachers are assigned to sections
  salaries                   TeacherSalary[]
  userRoles                  UserRole[]
  attendances                StaffAttendance[]
}

model Employee {
  id                         String                 @id @default(cuid())
  firstName                  String
  lastName                   String
  designation                String
  department                 String?
  joinDate                   DateTime               @default(now())
  isActive                   Boolean                @default(true)
  createdAt                  DateTime               @default(now())
  updatedAt                  DateTime               @updatedAt
  userId                     String?                @unique
  branchId                   String
  departmentId               String?
  designationId              String?
  certifications             String[]               @default([])
  subjects                   String[]               @default([])
  aadharNumber               String?
  accessCardId               String?
  accountNumber              String?
  address                    String?
  alternatePhone             String?
  assetReturnStatus          String?
  bankName                   String?
  bio                        String?
  bloodGroup                 String?
  city                       String?
  confirmationDate           DateTime?
  country                    String?
  dateOfBirth                DateTime?
  deviceIssued               String?
  emergencyContactName       String?
  emergencyContactPhone      String?
  emergencyContactRelation   String?
  employeeCode               String?                @unique
  employeeType               String?
  esiNumber                  String?
  experience                 String?
  gender                     String?
  ifscCode                   String?
  institution                String?
  maritalStatus              String?
  middleName                 String?
  nationality                String?
  officialEmail              String?
  panNumber                  String?
  permanentAddress           String?
  permanentCity              String?
  permanentCountry           String?
  permanentPincode           String?
  permanentState             String?
  personalEmail              String?
  pfNumber                   String?
  phone                      String?
  pincode                    String?
  previousEmployer           String?
  previousExperience         String?
  professionalQualifications String?
  qualification              String?
  religion                   String?
  reportingManager           String?
  salaryStructure            String?
  softwareLicenses           String?
  specialCertifications      String?
  specialization             String?
  state                      String?
  uanNumber                  String?
  yearOfCompletion           String?
  clerkId                    String?
  branch                     Branch                 @relation(fields: [branchId], references: [id])
  departmentRef              Department?            @relation("EmployeeDepartment", fields: [departmentId], references: [id])
  designationRef             Designation?           @relation("EmployeeDesignation", fields: [designationId], references: [id])
  branchAccessRecords        EmployeeBranchAccess[] @relation("EmployeeBranchAccessRecords")
  salaries                   EmployeeSalary[]
  leaveApplications          LeaveApplication[]
  leaveBalances              LeaveBalance[]
  salaryIncrements           SalaryIncrement[]
  userRoles                  UserRole[]
  staffAttendances           StaffAttendance[]
}

model Class {
  id                   String                 @id @default(cuid())
  name                 String
  isActive             Boolean                @default(true)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  branchId             String
  sessionId            String
  displayOrder         Int                    @default(0)
  description          String?
  grade                Int?
  
  // Relations
  branch               Branch                 @relation(fields: [branchId], references: [id])
  session              AcademicSession        @relation(fields: [sessionId], references: [id])
  sections             Section[]              // One class can have multiple sections
  subjects             ClassSubject[]
  blueprints           Blueprint[]
  classwiseFees        ClasswiseFee[]
  moneyCollectionLinks MoneyCollectionClass[] @relation("ClassMoneyCollectionLinks")
  // Examination relations
  examConfigurations   ExamConfiguration[]
  assessmentConfigs    AssessmentConfiguration[]
  // Customizable Assessment Engine relations
  assessmentSchemas    AssessmentSchema[]
  
  @@unique([name, branchId, sessionId]) // Ensure unique class names per branch/session
}

model Section {
  id                 String              @id @default(cuid())
  name               String
  capacity           Int                 @default(30)
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  classId            String
  teacherId          String?
  displayOrder       Int                 @default(0)
  
  // Relations
  class              Class               @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher            Teacher?            @relation(fields: [teacherId], references: [id])
  students           Student[]
  studentAttendances StudentAttendance[]
  // Examination relations
  examConfigurations ExamConfiguration[]
  assessmentConfigs  AssessmentConfiguration[]

  // Add database indexes for performance
  @@index([classId, isActive], name: "section_class_active_idx")
  @@index([isActive, displayOrder], name: "section_active_display_idx")
  @@unique([name, classId])
}

model AcademicSession {
  id               String            @id @default(cuid())
  name             String
  startDate        DateTime
  endDate          DateTime
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  academicRecords  AcademicRecord[]
  classes          Class[]
  classwiseFees    ClasswiseFee[]    @relation("ClasswiseFeeSession")
  feeCollections   FeeCollection[]   @relation("FeeCollectionSession")
  feeHeads         FeeHead[]         @relation("FeeHeadSession")
  feeTerms         FeeTerm[]         @relation("FeeTermSession")
  moneyCollections MoneyCollection[] @relation("MoneyCollectionSession")
}

model AcademicRecord {
  id        String          @id @default(cuid())
  studentId String
  sessionId String
  classId   String?
  status    String
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  session   AcademicSession @relation(fields: [sessionId], references: [id])
  student   Student         @relation(fields: [studentId], references: [id])
}

model TransferCertificate {
  id        String   @id @default(cuid())
  tcNumber  String   @unique
  issueDate DateTime @default(now())
  reason    String?
  remarks   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])
}

model StudentSibling {
  id               String   @id @default(cuid())
  relationshipType String
  createdAt        DateTime @default(now())
  studentId        String
  siblingId        String
  sibling          Student  @relation("SiblingToStudent", fields: [siblingId], references: [id], onDelete: Cascade)
  student          Student  @relation("StudentToSibling", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, siblingId])
}

model TransportRoute {
  id          String          @id @default(cuid())
  name        String
  description String?
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  branchId    String
  branch      Branch          @relation(fields: [branchId], references: [id])
  stops       TransportStop[]
}

model TransportStop {
  id          String                @id @default(cuid())
  name        String
  address     String?
  distance    Float?
  fee         Float
  sequence    Int
  isActive    Boolean               @default(true)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  routeId     String
  assignments TransportAssignment[]
  route       TransportRoute        @relation(fields: [routeId], references: [id], onDelete: Cascade)
}

model TransportAssignment {
  id        String        @id @default(cuid())
  startDate DateTime      @default(now())
  endDate   DateTime?
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  studentId String
  stopId    String
  stop      TransportStop @relation(fields: [stopId], references: [id])
  student   Student       @relation(fields: [studentId], references: [id])
}

model AttendanceLocation {
  id             String             @id @default(cuid())
  name           String
  latitude       Float
  longitude      Float
  radius         Int
  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  branchId       String
  locationTypeId String?
  devices        AttendanceDevice[]
  branch         Branch             @relation(fields: [branchId], references: [id])
  locationType   LocationType?      @relation(fields: [locationTypeId], references: [id])
  attendances    StaffAttendance[]

  @@map("attendanceLocation")
}

model LocationType {
  id                String               @id @default(cuid())
  name              String
  code              String
  description       String?
  isDefault         Boolean              @default(false)
  isActive          Boolean              @default(true)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  branchId          String
  locations         AttendanceLocation[]
  attendanceWindows AttendanceWindow[]
  branch            Branch               @relation(fields: [branchId], references: [id])

  @@map("locationType")
}

model AttendanceWindow {
  id                     String            @id @default(cuid())
  name                   String
  startTime              String
  endTime                String
  isMon                  Boolean           @default(true)
  isTue                  Boolean           @default(true)
  isWed                  Boolean           @default(true)
  isThu                  Boolean           @default(true)
  isFri                  Boolean           @default(true)
  isSat                  Boolean           @default(false)
  isSun                  Boolean           @default(false)
  allowLateMarking       Boolean           @default(false)
  lateMarkingGracePeriod Int               @default(0)
  isActive               Boolean           @default(true)
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  branchId               String
  locationTypeId         String
  branch                 Branch            @relation(fields: [branchId], references: [id])
  locationType           LocationType      @relation(fields: [locationTypeId], references: [id])
  attendanceRecords      StaffAttendance[]

  @@map("attendanceWindow")
}

model AttendanceDevice {
  id         String              @id @default(cuid())
  name       String
  deviceId   String              @unique
  isActive   Boolean             @default(true)
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  branchId   String
  locationId String?
  branch     Branch              @relation(fields: [branchId], references: [id])
  location   AttendanceLocation? @relation(fields: [locationId], references: [id])

  @@map("attendanceDevice")
}

model StaffAttendance {
  id                  String             @id @default(cuid())
  timestamp           DateTime           @default(now())
  latitude            Float
  longitude           Float
  distance            Int
  isWithinAllowedArea Boolean            @default(false)
  notes               String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  locationId          String
  teacherId           String?
  employeeId          String?
  windowId            String?
  type                AttendanceType     @default(IN)
  employee            Employee?          @relation(fields: [employeeId], references: [id])
  location            AttendanceLocation @relation(fields: [locationId], references: [id])
  teacher             Teacher?           @relation(fields: [teacherId], references: [id])
  attendanceWindow    AttendanceWindow?  @relation(fields: [windowId], references: [id])

  @@index([timestamp, type])
  @@index([teacherId, timestamp])
  @@index([employeeId, timestamp])
  @@map("staffAttendance")
}

model StudentAttendance {
  id         String           @id @default(cuid())
  date       DateTime         @default(now())
  status     AttendanceStatus @default(PRESENT)
  reason     String?
  notes      String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  studentId  String
  markedById String?
  sectionId  String
  section    Section          @relation(fields: [sectionId], references: [id])
  student    Student          @relation(fields: [studentId], references: [id])

  @@unique([studentId, date])
  @@index([date, sectionId])
  @@index([studentId, date])
  @@map("studentAttendance")
}

model Subject {
  id          String           @id @default(cuid())
  name        String
  code        String?
  description String?
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  chapters    Chapter[]
  classes     ClassSubject[]
  students    StudentSubject[]
  // Examination relations
  examConfigurations   ExamConfiguration[]
  assessmentConfigs    AssessmentConfiguration[]
  // Customizable Assessment Engine relations
  assessmentSchemas    AssessmentSchema[]
}

model ClassSubject {
  id        String   @id @default(cuid())
  classId   String
  subjectId String
  createdAt DateTime @default(now())
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([classId, subjectId])
}

model StudentSubject {
  id        String   @id @default(cuid())
  studentId String
  subjectId String
  createdAt DateTime @default(now())
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([studentId, subjectId])
}

model LeavePolicy {
  id                String             @id @default(cuid())
  name              String
  description       String?
  maxDaysPerYear    Int
  isPaid            Boolean            @default(true)
  applicableRoles   String[]
  branchId          String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  leaveApplications LeaveApplication[]
  leaveBalances     LeaveBalance[]
  branch            Branch             @relation(fields: [branchId], references: [id])
}

model LeaveBalance {
  id            String      @id @default(cuid())
  year          Int
  totalDays     Int
  usedDays      Int         @default(0)
  remainingDays Int
  policyId      String
  teacherId     String?
  employeeId    String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  employee      Employee?   @relation(fields: [employeeId], references: [id])
  policy        LeavePolicy @relation(fields: [policyId], references: [id])
  teacher       Teacher?    @relation(fields: [teacherId], references: [id])

  @@unique([policyId, teacherId, year])
  @@unique([policyId, employeeId, year])
}

model LeaveApplication {
  id         String      @id @default(cuid())
  startDate  DateTime
  endDate    DateTime
  reason     String
  status     String      @default("PENDING")
  comments   String?
  policyId   String
  teacherId  String?
  employeeId String?
  approvedBy String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  employee   Employee?   @relation(fields: [employeeId], references: [id])
  policy     LeavePolicy @relation(fields: [policyId], references: [id])
  teacher    Teacher?    @relation(fields: [teacherId], references: [id])
}

model RbacRole {
  id          String               @id @default(cuid())
  name        String               @unique
  description String?
  isSystem    Boolean              @default(false)
  isActive    Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  permissions RbacRolePermission[]
  userRoles   UserRole[]
}

model RbacPermission {
  id              String               @id @default(cuid())
  name            String               @unique
  description     String?
  category        String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  rolePermissions RbacRolePermission[]
}

model RbacRolePermission {
  id           String         @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime       @default(now())
  permission   RbacPermission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         RbacRole       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

model UserRole {
  id         String    @id @default(cuid())
  userId     String
  roleId     String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  teacherId  String?
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id])
  role       RbacRole  @relation(fields: [roleId], references: [id])
  teacher    Teacher?  @relation(fields: [teacherId], references: [id])

  @@unique([userId, roleId])
}

model SalaryStructure {
  id               String           @id @default(cuid())
  name             String
  description      String?
  basicSalary      Float
  daPercentage     Float            @default(0)
  pfPercentage     Float            @default(0)
  esiPercentage    Float            @default(0)
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  employeeSalaries EmployeeSalary[]
  teacherSalaries  TeacherSalary[]
}

model EmployeeSalary {
  id                   String          @id @default(cuid())
  employeeId           String
  structureId          String
  customBasicSalary    Float?
  customDaPercentage   Float?
  customPfPercentage   Float?
  customEsiPercentage  Float?
  additionalAllowances Float           @default(0)
  startDate            DateTime        @default(now())
  endDate              DateTime?
  isActive             Boolean         @default(true)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  employee             Employee        @relation(fields: [employeeId], references: [id])
  structure            SalaryStructure @relation(fields: [structureId], references: [id])
  salaryPayments       SalaryPayment[]

  @@unique([employeeId, structureId, startDate])
}

model TeacherSalary {
  id                   String          @id @default(cuid())
  teacherId            String
  structureId          String
  customBasicSalary    Float?
  customDaPercentage   Float?
  customPfPercentage   Float?
  customEsiPercentage  Float?
  additionalAllowances Float           @default(0)
  startDate            DateTime        @default(now())
  endDate              DateTime?
  isActive             Boolean         @default(true)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  salaryPayments       SalaryPayment[]
  structure            SalaryStructure @relation(fields: [structureId], references: [id])
  teacher              Teacher         @relation(fields: [teacherId], references: [id])

  @@unique([teacherId, structureId, startDate])
}

model SalaryPayment {
  id                      String          @id @default(cuid())
  month                   Int
  year                    Int
  basicSalary             Float
  daAmount                Float
  pfDeduction             Float
  esiDeduction            Float
  employerPfContribution  Float
  employerEsiContribution Float
  additionalAllowances    Float           @default(0)
  leaveDeductions         Float           @default(0)
  otherDeductions         Float           @default(0)
  otherAdditions          Float           @default(0)
  totalEarnings           Float
  totalDeductions         Float
  netPayable              Float
  paymentDate             DateTime?
  paymentStatus           String          @default("PENDING")
  remarks                 String?
  teacherSalaryId         String?
  employeeSalaryId        String?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  employeeSalary          EmployeeSalary? @relation(fields: [employeeSalaryId], references: [id])
  teacherSalary           TeacherSalary?  @relation(fields: [teacherSalaryId], references: [id])

  @@unique([month, year, teacherSalaryId])
  @@unique([month, year, employeeSalaryId])
}

model SalaryIncrement {
  id                  String    @id @default(cuid())
  incrementAmount     Float?
  incrementPercentage Float?
  oldBasicSalary      Float
  newBasicSalary      Float
  effectiveDate       DateTime
  remarks             String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  teacherId           String?
  employeeId          String?
  appliedById         String?
  employee            Employee? @relation(fields: [employeeId], references: [id])
  teacher             Teacher?  @relation(fields: [teacherId], references: [id])

  @@index([teacherId])
  @@index([employeeId])
  @@index([effectiveDate])
}

model Department {
  id          String     @id @default(cuid())
  name        String
  code        String     @unique
  description String?
  type        String
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  branchId    String
  headId      String?
  branch      Branch     @relation(fields: [branchId], references: [id])
  employees   Employee[] @relation("EmployeeDepartment")
}

model Designation {
  id          String     @id @default(cuid())
  title       String
  code        String     @unique
  description String?
  category    String
  level       String
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  branchId    String
  branch      Branch     @relation(fields: [branchId], references: [id])
  employees   Employee[] @relation("EmployeeDesignation")
}

model AdmissionLead {
  id                       String                @id @default(cuid())
  firstName                String
  lastName                 String
  email                    String?
  phone                    String?
  parentName               String?
  parentPhone              String?
  parentEmail              String?
  address                  String?
  city                     String?
  state                    String?
  country                  String?
  zipCode                  String?
  gradeApplyingFor         String?
  academicSession          String?
  sourceId                 String?
  status                   AdmissionStatus       @default(NEW)
  notes                    String?
  assignedToId             String?
  createdAt                DateTime              @default(now())
  updatedAt                DateTime              @updatedAt
  branchId                 String
  leadType                 String?
  appliedClass             String?
  birthDate                DateTime?
  gender                   String?
  nextFollowUpDate         DateTime?
  lastContactDate          DateTime?
  registrationNumber       String?
  provisionalInvoiceNumber String?
  application              AdmissionApplication?
  assignedTo               AdmissionStaff?       @relation(fields: [assignedToId], references: [id])
  branch                   Branch                @relation(fields: [branchId], references: [id])
  source                   LeadSource?           @relation(fields: [sourceId], references: [id])
  offer                    AdmissionOffer?
  assessments              Assessment[]
  followUps                FollowUp[]
  documents                LeadDocument[]
  interactions             LeadInteraction[]
  payments                 PaymentTransaction[]
}

model LeadSource {
  id          String          @id @default(cuid())
  name        String
  description String?
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  leads       AdmissionLead[]
}

model LeadInteraction {
  id            String          @id @default(cuid())
  leadId        String
  type          String
  description   String
  date          DateTime
  conductedById String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  conductedBy   AdmissionStaff? @relation(fields: [conductedById], references: [id])
  lead          AdmissionLead   @relation(fields: [leadId], references: [id])
}

model LeadDocument {
  id           String          @id @default(cuid())
  leadId       String
  name         String
  type         String
  url          String
  uploadedAt   DateTime        @default(now())
  uploadedById String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  lead         AdmissionLead   @relation(fields: [leadId], references: [id])
  uploadedBy   AdmissionStaff? @relation(fields: [uploadedById], references: [id])
}

model FollowUp {
  id            String          @id @default(cuid())
  leadId        String
  scheduledDate DateTime
  description   String
  status        FollowUpStatus  @default(PENDING)
  completedDate DateTime?
  assignedToId  String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  assignedTo    AdmissionStaff? @relation(fields: [assignedToId], references: [id])
  lead          AdmissionLead   @relation(fields: [leadId], references: [id])
}

model AdmissionStaff {
  id                   String                 @id @default(cuid())
  userId               String?                @unique
  clerkId              String?
  name                 String
  email                String?
  phone                String?
  role                 String
  isActive             Boolean                @default(true)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  applications         AdmissionApplication[]
  leads                AdmissionLead[]
  conductedAssessments Assessment[]
  followUps            FollowUp[]
  documents            LeadDocument[]
  interactions         LeadInteraction[]
  processedPayments    PaymentTransaction[]
}

model AdmissionApplication {
  id                String                   @id @default(cuid())
  leadId            String                   @unique
  applicationNumber String                   @unique
  applicationDate   DateTime                 @default(now())
  status            ApplicationStatus        @default(SUBMITTED)
  currentStage      String?
  assignedToId      String?
  reviewedById      String?
  reviewDate        DateTime?
  decisionDate      DateTime?
  decisionById      String?
  decisionNotes     String?
  offerAcceptedDate DateTime?
  feePaid           Boolean                  @default(false)
  feeAmount         Float?
  feeDate           DateTime?
  enrollmentDate    DateTime?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  assignedTo        AdmissionStaff?          @relation(fields: [assignedToId], references: [id])
  lead              AdmissionLead            @relation(fields: [leadId], references: [id])
  requirements      ApplicationRequirement[]
  stages            ApplicationStage[]
}

model ApplicationStage {
  id            String               @id @default(cuid())
  applicationId String
  name          String
  description   String?
  sequence      Int
  startDate     DateTime?
  endDate       DateTime?
  status        StageStatus          @default(PENDING)
  completedById String?
  completedDate DateTime?
  notes         String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  application   AdmissionApplication @relation(fields: [applicationId], references: [id])
}

model ApplicationRequirement {
  id            String               @id @default(cuid())
  applicationId String
  name          String
  description   String?
  isRequired    Boolean              @default(true)
  status        RequirementStatus    @default(PENDING)
  completedDate DateTime?
  notes         String?
  documentUrl   String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  application   AdmissionApplication @relation(fields: [applicationId], references: [id])
}

model PaymentTransaction {
  id            String          @id @default(cuid())
  leadId        String
  amount        Float
  method        String
  status        String
  type          String
  reference     String?
  transactionId String?
  invoiceNumber String?
  paymentDate   DateTime        @default(now())
  notes         String?
  processedById String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  lead          AdmissionLead   @relation(fields: [leadId], references: [id])
  processedBy   AdmissionStaff? @relation(fields: [processedById], references: [id])
}

model Assessment {
  id            String          @id @default(cuid())
  leadId        String
  scheduledDate DateTime
  actualDate    DateTime?
  assessorId    String?
  type          String
  subject       String?
  status        String
  score         Float?
  maxScore      Float?
  result        String?
  notes         String?
  location      String?
  duration      Int?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  assessor      AdmissionStaff? @relation(fields: [assessorId], references: [id])
  lead          AdmissionLead   @relation(fields: [leadId], references: [id])
}

model AdmissionOffer {
  id             String        @id @default(cuid())
  leadId         String        @unique
  offerDate      DateTime      @default(now())
  expiryDate     DateTime
  status         String
  offerLetterUrl String?
  terms          String?
  confirmedDate  DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  lead           AdmissionLead @relation(fields: [leadId], references: [id])
}

model EmployeeBranchAccess {
  id         String   @id @default(cuid())
  employeeId String
  branchId   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  employee   Employee @relation("EmployeeBranchAccessRecords", fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, branchId])
}

model Chapter {
  id          String             @id @default(cuid())
  name        String
  code        String?
  description String?
  subjectId   String
  branchId    String?
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  blueprints  BlueprintChapter[]
  branch      Branch?            @relation(fields: [branchId], references: [id])
  subject     Subject            @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  questions   Question[]
  subTopics   SubTopic[]
}

model SubTopic {
  id          String     @id @default(cuid())
  name        String
  description String?
  chapterId   String
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  questions   Question[]
  chapter     Chapter    @relation(fields: [chapterId], references: [id], onDelete: Cascade)
}

model Question {
  id                 String          @id @default(cuid())
  text               String
  marks              Int
  chapterId          String
  subTopicId         String?
  isActive           Boolean         @default(true)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  creatorId          String?
  isAIGenerated      Boolean         @default(false)
  type               String
  difficulty         String
  applicableSubjects String[]        @default([])
  category           String          @default("Objective")
  subtype            String          @default("MCQ")
  paperQuestions     PaperQuestion[]
  chapter            Chapter         @relation(fields: [chapterId], references: [id])
  subTopic           SubTopic?       @relation(fields: [subTopicId], references: [id])
}

model EducationBoard {
  id          String      @id @default(cuid())
  name        String
  code        String      @unique
  description String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  blueprints  Blueprint[]
}

model Blueprint {
  id             String             @id @default(cuid())
  name           String
  description    String?
  classId        String
  boardId        String?
  creatorId      String?
  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  board          EducationBoard?    @relation(fields: [boardId], references: [id])
  class          Class              @relation(fields: [classId], references: [id])
  chapters       BlueprintChapter[]
  sections       BlueprintSection[]
  questionPapers QuestionPaper[]
}

model BlueprintChapter {
  id          String    @id @default(cuid())
  blueprintId String
  chapterId   String
  createdAt   DateTime  @default(now())
  blueprint   Blueprint @relation(fields: [blueprintId], references: [id], onDelete: Cascade)
  chapter     Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@unique([blueprintId, chapterId])
}

model BlueprintSection {
  id                      String         @id @default(cuid())
  blueprintId             String
  name                    String
  description             String?
  questionCount           Int
  instructions            String?
  sectionOrder            Int            @default(0)
  createdAt               DateTime       @default(now())
  objectiveQuestionCount  Int            @default(0)
  requiredSubtypes        String[]       @default([])
  subjectiveQuestionCount Int            @default(0)
  blueprint               Blueprint      @relation(fields: [blueprintId], references: [id], onDelete: Cascade)
  paperSections           PaperSection[]
}

model QuestionPaper {
  id          String         @id @default(cuid())
  title       String
  description String?
  duration    Int?
  totalMarks  Int?
  blueprintId String
  creatorId   String?
  isPublished Boolean        @default(false)
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  sections    PaperSection[]
  blueprint   Blueprint      @relation(fields: [blueprintId], references: [id])
}

model PaperSection {
  id                 String           @id @default(cuid())
  questionPaperId    String
  blueprintSectionId String
  name               String
  instructions       String?
  sectionOrder       Int              @default(0)
  createdAt          DateTime         @default(now())
  questions          PaperQuestion[]
  blueprintSection   BlueprintSection @relation(fields: [blueprintSectionId], references: [id])
  questionPaper      QuestionPaper    @relation(fields: [questionPaperId], references: [id], onDelete: Cascade)
}

model PaperQuestion {
  id             String       @id @default(cuid())
  paperSectionId String
  questionId     String
  questionOrder  Int
  marks          Int?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  paperSection   PaperSection @relation(fields: [paperSectionId], references: [id])
  question       Question     @relation(fields: [questionId], references: [id])
}

model TextbookProcessing {
  id                  String    @id @default(cuid())
  fileUrl             String
  fileName            String
  classId             String
  subjectId           String
  chapterId           String
  status              String
  errorMessage        String?
  questionsGenerated  Int?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  completedAt         DateTime?
  creatorId           String
  batchConcurrency    Int?
  batchProcessingUsed Boolean   @default(false)
  batchSize           Int?
  processingDuration  Int?
}

model MoneyCollection {
  id             String                 @id @default(cuid())
  title          String
  description    String?
  collectionDate DateTime?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  branchId       String
  sessionId      String?
  branch         Branch                 @relation(fields: [branchId], references: [id])
  session        AcademicSession?       @relation("MoneyCollectionSession", fields: [sessionId], references: [id])
  classes        MoneyCollectionClass[]
  items          MoneyCollectionItem[]
}

model MoneyCollectionClass {
  id                String          @id @default(cuid())
  moneyCollectionId String
  classId           String
  createdAt         DateTime        @default(now())
  class             Class           @relation("ClassMoneyCollectionLinks", fields: [classId], references: [id])
  moneyCollection   MoneyCollection @relation(fields: [moneyCollectionId], references: [id], onDelete: Cascade)

  @@unique([moneyCollectionId, classId])
}

model MoneyCollectionItem {
  id                String          @id @default(cuid())
  amount            Float
  notes             String?
  receivedAt        DateTime        @default(now())
  moneyCollectionId String
  studentId         String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  moneyCollection   MoneyCollection @relation(fields: [moneyCollectionId], references: [id], onDelete: Cascade)
  student           Student         @relation(fields: [studentId], references: [id])
}

model FeeHead {
  id                 String              @id @default(cuid())
  name               String
  description        String?
  isSystemDefined    Boolean             @default(false)
  isActive           Boolean             @default(true)
  branchId           String
  sessionId          String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  classwiseFees      ClasswiseFee[]
  feeCollectionItems FeeCollectionItem[]
  branch             Branch              @relation(fields: [branchId], references: [id])
  session            AcademicSession     @relation("FeeHeadSession", fields: [sessionId], references: [id])
  feeTerms           FeeTermFeeHead[]

  @@unique([name, branchId, sessionId])
}

model FeeTerm {
  id             String           @id @default(cuid())
  name           String
  description    String?
  startDate      DateTime
  endDate        DateTime
  dueDate        DateTime
  isActive       Boolean          @default(true)
  branchId       String
  sessionId      String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  classwiseFees  ClasswiseFee[]
  feeCollections FeeCollection[]
  branch         Branch           @relation(fields: [branchId], references: [id])
  session        AcademicSession  @relation("FeeTermSession", fields: [sessionId], references: [id])
  feeHeads       FeeTermFeeHead[]

  @@unique([name, branchId, sessionId])
}

model FeeTermFeeHead {
  id        String   @id @default(cuid())
  feeTermId String
  feeHeadId String
  createdAt DateTime @default(now())
  feeHead   FeeHead  @relation(fields: [feeHeadId], references: [id], onDelete: Cascade)
  feeTerm   FeeTerm  @relation(fields: [feeTermId], references: [id], onDelete: Cascade)

  @@unique([feeTermId, feeHeadId])
}

model ClasswiseFee {
  id        String          @id @default(cuid())
  classId   String
  feeTermId String
  feeHeadId String
  amount    Float
  branchId  String
  sessionId String
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  branch    Branch          @relation(fields: [branchId], references: [id])
  class     Class           @relation(fields: [classId], references: [id])
  feeHead   FeeHead         @relation(fields: [feeHeadId], references: [id])
  feeTerm   FeeTerm         @relation(fields: [feeTermId], references: [id])
  session   AcademicSession @relation("ClasswiseFeeSession", fields: [sessionId], references: [id])

  @@unique([classId, feeTermId, feeHeadId])
}

model FeeCollection {
  id                   String              @id @default(cuid())
  receiptNumber        String              @unique
  studentId            String
  feeTermId            String
  totalAmount          Float
  paidAmount           Float
  paymentMode          String
  transactionReference String?
  paymentDate          DateTime
  notes                String?
  status               String              @default("COMPLETED")
  branchId             String
  sessionId            String
  createdBy            String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  branch               Branch              @relation(fields: [branchId], references: [id])
  feeTerm              FeeTerm             @relation(fields: [feeTermId], references: [id])
  session              AcademicSession     @relation("FeeCollectionSession", fields: [sessionId], references: [id])
  student              Student             @relation(fields: [studentId], references: [id])
  items                FeeCollectionItem[]
}

model FeeCollectionItem {
  id              String        @id @default(cuid())
  feeCollectionId String
  feeHeadId       String
  amount          Float
  createdAt       DateTime      @default(now())
  feeCollection   FeeCollection @relation(fields: [feeCollectionId], references: [id], onDelete: Cascade)
  feeHead         FeeHead       @relation(fields: [feeHeadId], references: [id])
}

enum AttendanceType {
  IN
  OUT
  BRANCH_TRANSFER_OUT
  BRANCH_TRANSFER_IN
}

enum AttendanceStatus {
  PRESENT
  LEAVE
  ABSENT
  HALF_DAY
  LATE
}

enum AdmissionStatus {
  NEW
  CONTACTED
  ENGAGED
  TOUR_SCHEDULED
  TOUR_COMPLETED
  APPLICATION_SENT
  APPLICATION_RECEIVED
  FEE_PAID
  ASSESSMENT_SCHEDULED
  ASSESSMENT_COMPLETED
  INTERVIEW_SCHEDULED
  INTERVIEW_COMPLETED
  DECISION_PENDING
  OFFERED
  ACCEPTED
  REJECTED
  WAITLISTED
  ENROLLED
  CLOSED_LOST
  ARCHIVE
}

enum FollowUpStatus {
  PENDING
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  IN_PROCESS
  AWAITING_DOCUMENTS
  READY_FOR_DECISION
  OFFERED
  ACCEPTED
  REJECTED
  WAITLISTED
  WITHDRAWN
  ENROLLED
}

enum StageStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
  FAILED
}

enum RequirementStatus {
  PENDING
  SUBMITTED
  APPROVED
  REJECTED
  WAIVED
}

enum QuestionType {
  MCQ
  SHORT_ANSWER
  LONG_ANSWER
  TRUE_FALSE
  FILL_IN_BLANKS
  MATCH_THE_FOLLOWING
  ASSERTION_REASONING
  DESCRIPTIVE
  ANALYTICAL
  EVALUATIVE
  COMPARATIVE
  APPLICATION_BASED
  CASE_STUDY
  OPINION_BASED
  EXPLORATORY
  CAUSE_EFFECT
  HYPOTHETICAL
  INTERPRETIVE
  JUSTIFICATION
}

enum QuestionCategory {
  OBJECTIVE
  SUBJECTIVE
}

enum QuestionDifficulty {
  EASY
  MEDIUM
  HARD
}

// Background Tasks and Email Configuration Models
model BackgroundTask {
  id              String            @id @default(cuid())
  taskType        String            // e.g., "BULK_CLERK_CREATION"
  title           String
  description     String?
  status          BackgroundTaskStatus @default(PENDING)
  
  // Progress tracking
  totalItems      Int               @default(0)
  processedItems  Int               @default(0)
  failedItems     Int               @default(0)
  percentage      Float             @default(0)
  
  // Task data and results
  inputData       Json?             // Task input parameters
  results         Json?             // Task execution results
  errors          Json[]            @default([])
  
  // Timing
  scheduledAt     DateTime?         // When to run the task
  startedAt       DateTime?         // When task actually started
  completedAt     DateTime?         // When task finished
  estimatedDuration Int?            // Estimated duration in seconds
  
  // Metadata
  createdBy       String?           // User who created the task
  branchId        String?
  priority        Int               @default(5) // 1-10 (1 = highest)
  
  // System fields
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relationships
  branch          Branch?           @relation(fields: [branchId], references: [id])
  executionLogs   TaskExecutionLog[]
  
  @@index([status, scheduledAt])
  @@index([branchId, status])
  @@index([taskType, status])
}

model EmailConfiguration {
  id                String    @id @default(cuid())
  
  // SMTP Configuration
  smtpHost          String?
  smtpPort          Int?      @default(587)
  smtpUsername      String?
  smtpPassword      String?   // Should be encrypted
  
  // Email Settings
  fromEmail         String?
  fromName          String?   @default("Scholarise System")
  
  // Notification Recipients
  adminEmails       String[]  @default([])
  
  // Task Notification Settings
  notifyOnTaskCompletion   Boolean @default(true)
  notifyOnTaskFailure      Boolean @default(true)
  includeTaskDetails       Boolean @default(true)
  includeErrorLogs         Boolean @default(false)
  
  // Email Templates
  taskCompletionTemplate   String?
  taskFailureTemplate      String?
  
  // Branch-specific or global
  branchId          String?   @unique
  isGlobal          Boolean   @default(false)
  isActive          Boolean   @default(true)
  
  // System fields
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relationships
  branch            Branch?   @relation(fields: [branchId], references: [id])
  
  @@index([branchId, isActive])
}

// Task execution logs for debugging
model TaskExecutionLog {
  id              String           @id @default(cuid())
  taskId          String
  level           TaskLogLevel     @default(INFO)
  message         String
  details         Json?
  timestamp       DateTime         @default(now())
  
  // Relationships
  task            BackgroundTask   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  @@index([taskId, timestamp])
  @@index([level, timestamp])
}

enum BackgroundTaskStatus {
  PENDING
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  RETRY
}

enum TaskLogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  FATAL
}

// Examination Module Models
model ExamType {
  id               String @id @default(cuid())
  name             String // e.g., "Unit Test", "Mid Term", "Final", "Pre-Board"
  code             String @unique
  description      String?
  isActive         Boolean @default(true)
  order            Int @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  branchId         String
  branch           Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  examSchedules    ExamSchedule[]
  examConfigurations ExamConfiguration[]
  
  @@index([branchId, isActive])
}

model ExamConfiguration {
  id               String @id @default(cuid())
  name             String // e.g., "Class 10 Unit Test 1"
  examTypeId       String
  classId          String
  sectionId        String?
  subjectId        String
  maxMarks         Int
  passingMarks     Int
  weightage        Float @default(1.0) // For calculating overall percentage
  isActive         Boolean @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  branchId         String
  branch           Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  examType         ExamType @relation(fields: [examTypeId], references: [id])
  class            Class @relation(fields: [classId], references: [id])
  section          Section? @relation(fields: [sectionId], references: [id])
  subject          Subject @relation(fields: [subjectId], references: [id])
  examSchedules    ExamSchedule[]
  marksEntries     MarksEntry[]
  
  @@unique([examTypeId, classId, sectionId, subjectId])
  @@index([branchId, isActive])
  @@index([classId, sectionId])
}

model ExamSchedule {
  id               String @id @default(cuid())
  examConfigId     String
  examDate         DateTime
  startTime        DateTime
  endTime          DateTime
  room             String?
  invigilator      String?
  instructions     String?
  isActive         Boolean @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  branchId         String
  branch           Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  examConfig       ExamConfiguration @relation(fields: [examConfigId], references: [id])
  examType         ExamType @relation(fields: [examTypeId], references: [id])
  examTypeId       String
  seatingPlans     SeatingPlan[]
  
  @@index([branchId, examDate])
  @@index([examConfigId])
}

model SeatingPlan {
  id               String @id @default(cuid())
  examScheduleId   String
  studentId        String
  seatNumber       String
  room             String
  row              Int?
  column           Int?
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  branchId         String
  branch           Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  examSchedule     ExamSchedule @relation(fields: [examScheduleId], references: [id])
  student          Student @relation(fields: [studentId], references: [id])
  
  @@unique([examScheduleId, seatNumber, room])
  @@index([branchId, examScheduleId])
  @@index([studentId])
}

model MarksEntry {
  id               String @id @default(cuid())
  examConfigId     String
  studentId        String
  marksObtained    Float?
  isAbsent         Boolean @default(false)
  remarks          String?
  enteredBy        String // Teacher/Employee ID
  enteredAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  isSubmitted      Boolean @default(false)
  submittedAt      DateTime?
  branchId         String
  branch           Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  examConfig       ExamConfiguration @relation(fields: [examConfigId], references: [id])
  student          Student @relation(fields: [studentId], references: [id])
  
  @@unique([examConfigId, studentId])
  @@index([branchId, examConfigId])
  @@index([studentId])
  @@index([enteredBy])
}

// Academic Assessment Categories
model AssessmentCategory {
  id               String @id @default(cuid())
  name             String // e.g., "Subject Enrichment", "Lesson Ending Test", "Project Work"
  code             String @unique
  description      String?
  maxMarks         Int
  isActive         Boolean @default(true)
  order            Int @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  branchId         String
  branch           Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  assessmentConfigs AssessmentConfiguration[]
  
  @@index([branchId, isActive])
}

model AssessmentConfiguration {
  id               String @id @default(cuid())
  name             String // e.g., "Debate Competition", "Math Project"
  categoryId       String
  classId          String
  sectionId        String?
  subjectId        String?
  maxMarks         Int
  weightage        Float @default(1.0)
  dueDate          DateTime?
  instructions     String?
  isActive         Boolean @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  branchId         String
  branch           Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  category         AssessmentCategory @relation(fields: [categoryId], references: [id])
  class            Class @relation(fields: [classId], references: [id])
  section          Section? @relation(fields: [sectionId], references: [id])
  subject          Subject? @relation(fields: [subjectId], references: [id])
  assessmentMarks  AssessmentMarks[]
  
  @@index([branchId, isActive])
  @@index([classId, sectionId])
}

model AssessmentMarks {
  id               String @id @default(cuid())
  assessmentConfigId String
  studentId        String
  marksObtained    Float?
  comments         String?
  submissionDate   DateTime?
  enteredBy        String // Teacher/Employee ID
  enteredAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  isSubmitted      Boolean @default(false)
  submittedAt      DateTime?
  branchId         String
  branch           Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  assessmentConfig AssessmentConfiguration @relation(fields: [assessmentConfigId], references: [id])
  student          Student @relation(fields: [studentId], references: [id])
  
  @@unique([assessmentConfigId, studentId])
  @@index([branchId, assessmentConfigId])
  @@index([studentId])
  @@index([enteredBy])
}

// Grade Configuration for Result Processing
model GradeScale {
  id               String @id @default(cuid())
  name             String // e.g., "CBSE Grading", "ICSE Grading"
  isDefault        Boolean @default(false)
  isActive         Boolean @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  branchId         String
  branch           Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  gradeRanges      GradeRange[]
  
  @@index([branchId, isActive])
}

model GradeRange {
  id               String @id @default(cuid())
  gradeScaleId     String
  grade            String // e.g., "A1", "A2", "B1"
  minPercentage    Float
  maxPercentage    Float
  gradePoint       Float?
  description      String?
  order            Int @default(0)
  gradeScale       GradeScale @relation(fields: [gradeScaleId], references: [id], onDelete: Cascade)
  
  @@index([gradeScaleId, minPercentage])
}

// Customizable Assessment Engine Models

// Assessment Schema (e.g., English Term-1 Schema)
model AssessmentSchema {
  id               String @id @default(cuid())
  name             String // e.g., "English Term-1 Evaluation"
  term             String // e.g., "Term-1", "Half-Yearly", "Annual"
  classId          String
  subjectId        String
  totalMarks       Int @default(100)
  isActive         Boolean @default(true)
  isPublished      Boolean @default(false)
  createdBy        String // Employee/Teacher ID
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  branchId         String
  // JSON field to store selected classes and sections
  appliedClasses   Json? // Stores array of {classId, sectionId?, className, sectionName?}
  branch           Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  class            Class @relation(fields: [classId], references: [id])
  subject          Subject @relation(fields: [subjectId], references: [id])
  components       AssessmentComponent[]
  studentScores    StudentAssessmentScore[]
  permissions      AssessmentPermission[]
  
  @@unique([branchId, classId, subjectId, term])
  @@index([branchId, isActive])
  @@index([classId, subjectId])
}

// Assessment Components (e.g., Periodic Test, Multiple Assessment, etc.)
model AssessmentComponent {
  id               String @id @default(cuid())
  name             String // e.g., "Periodic Test", "Multiple Assessment"
  description      String?
  assessmentSchemaId String
  rawMaxScore      Int // Original maximum marks
  reducedScore     Float // Weighted/reduced marks
  weightage        Float @default(1.0) // Weight in final calculation
  formula          String? // Custom formula for calculation
  order            Int @default(0)
  isActive         Boolean @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  assessmentSchema AssessmentSchema @relation(fields: [assessmentSchemaId], references: [id], onDelete: Cascade)
  subCriteria      AssessmentSubCriteria[]
  componentScores  ComponentScore[]
  
  @@index([assessmentSchemaId, order])
}

// Sub-criteria for components (e.g., Individual Activities, Handwriting, etc.)
model AssessmentSubCriteria {
  id               String @id @default(cuid())
  name             String // e.g., "Individual Activities", "Handwriting"
  description      String?
  componentId      String
  maxScore         Int
  order            Int @default(0)
  isActive         Boolean @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  component        AssessmentComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)
  subCriteriaScores SubCriteriaScore[]
  
  @@index([componentId, order])
}

// Student scores for each assessment schema
model StudentAssessmentScore {
  id               String @id @default(cuid())
  assessmentSchemaId String
  studentId        String
  finalScore       Float?
  finalGrade       String?
  finalPercentage  Float?
  isComplete       Boolean @default(false)
  submittedAt      DateTime?
  enteredBy        String // Teacher/Employee ID
  enteredAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  branchId         String
  branch           Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  assessmentSchema AssessmentSchema @relation(fields: [assessmentSchemaId], references: [id], onDelete: Cascade)
  student          Student @relation(fields: [studentId], references: [id])
  componentScores  ComponentScore[]
  
  @@unique([assessmentSchemaId, studentId])
  @@index([branchId, assessmentSchemaId])
  @@index([studentId])
  @@index([enteredBy])
}

// Student scores for each component
model ComponentScore {
  id               String @id @default(cuid())
  componentId      String
  studentAssessmentScoreId String
  rawScore         Float?
  reducedScore     Float?
  calculatedScore  Float?
  isComplete       Boolean @default(false)
  enteredBy        String // Teacher/Employee ID
  enteredAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  component        AssessmentComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)
  studentScore     StudentAssessmentScore @relation(fields: [studentAssessmentScoreId], references: [id], onDelete: Cascade)
  subCriteriaScores SubCriteriaScore[]
  
  @@unique([componentId, studentAssessmentScoreId])
  @@index([componentId])
  @@index([studentAssessmentScoreId])
}

// Student scores for sub-criteria
model SubCriteriaScore {
  id               String @id @default(cuid())
  subCriteriaId    String
  componentScoreId String
  score            Float?
  comments         String?
  enteredBy        String // Teacher/Employee ID
  enteredAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  subCriteria      AssessmentSubCriteria @relation(fields: [subCriteriaId], references: [id], onDelete: Cascade)
  componentScore   ComponentScore @relation(fields: [componentScoreId], references: [id], onDelete: Cascade)
  
  @@unique([subCriteriaId, componentScoreId])
  @@index([subCriteriaId])
  @@index([componentScoreId])
}

// Assessment Permissions
model AssessmentPermission {
  id               String @id @default(cuid())
  assessmentSchemaId String?
  userId           String // Employee/Teacher ID
  permissionType   AssessmentPermissionType
  canCreate        Boolean @default(false)
  canEdit          Boolean @default(false)
  canView          Boolean @default(true)
  canDelete        Boolean @default(false)
  canPublish       Boolean @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  branchId         String
  branch           Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  assessmentSchema AssessmentSchema? @relation(fields: [assessmentSchemaId], references: [id], onDelete: Cascade)
  
  @@unique([assessmentSchemaId, userId])
  @@index([branchId, userId])
  @@index([userId, permissionType])
}

enum AssessmentPermissionType {
  ADMIN
  SUBJECT_COORDINATOR
  TEACHER
  VIEW_ONLY
}
